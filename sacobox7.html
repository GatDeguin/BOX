<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Box 7 ‚Ä¢ Ring POV + Pose</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MediaPipe Pose (globals) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      background: #05060a;
      overflow: hidden;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5e7eb;
    }
    #canvas-container {
      position: fixed;
      inset: 0;
    }
    #info {
      position: fixed;
      top: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 20px;
      pointer-events: none;
      z-index: 20;
    }
    #info .instruction {
      background: rgba(12, 15, 25, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.55);
      min-width: min(640px, 92vw);
      pointer-events: auto;
    }
    #controls {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      z-index: 30;
    }
    .pill-btn {
      background: rgba(0, 0, 0, 0.65);
      color: #f8fafc;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .pill-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 32px rgba(0, 0, 0, 0.35);
    }
    #presetBtn { position: fixed; top: 16px; left: 16px; z-index: 30; }
    #viewBtn { position: fixed; top: 16px; left: 140px; z-index: 30; }

    /* Webcam overlay */
    #input_video {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 240px;
      max-width: 40vw;
      border-radius: 12px;
      transform: scaleX(-1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      background: #000;
      z-index: 40;
    }
    #pose_canvas {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 240px;
      max-width: 40vw;
      pointer-events: none;
      transform: scaleX(-1);
      z-index: 41;
    }
    .webcam-label {
      position: fixed;
      bottom: 12px;
      right: 18px;
      transform: translateY(100%);
      font-size: 11px;
      color: #cbd5f5;
      text-shadow: 0 2px 12px rgba(0, 0, 0, 0.9);
      z-index: 42;
      pointer-events: none;
    }

    /* Error overlay */
    #camera-error-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 20%, rgba(255, 95, 109, 0.12), transparent 32%),
        radial-gradient(circle at 70% 80%, rgba(76, 201, 240, 0.12), transparent 36%),
        rgba(2, 4, 12, 0.9);
      z-index: 80;
    }
    #camera-error-overlay.visible { display: flex; }
    .camera-error-card {
      background: rgba(9, 12, 20, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      width: min(90vw, 420px);
      text-align: center;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.45);
    }
    #canvas-container canvas { cursor: crosshair; }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
        "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
      }
    }
  </script>
</head>
<body>
  <div id="info">
    <div class="instruction">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-300 mb-1">Box 7 ‚Ä¢ Ring POV</p>
      <h1 class="text-2xl font-black text-orange-100 mb-2">Webcam + Pose + Tyson</h1>
      <div class="text-sm text-slate-300 leading-relaxed">
        <p>Click en la escena para activar c√°mara y control por pose. Mant√©n el guardia frente al saco o alterna a tercera persona para recorrer el ring.</p>
        <p class="mt-2 text-[11px] text-slate-400 uppercase tracking-[0.2em]">Atajos: [V] Vista 1¬™/3¬™ ‚Ä¢ [L] D√≠a/Noche ‚Ä¢ [M] Mute ‚Ä¢ [Espacio] Pausa pose</p>
      </div>
    </div>
  </div>

  <button id="presetBtn" class="pill-btn">üåô Noche</button>
  <button id="viewBtn" class="pill-btn">üëÅÔ∏è 1¬™ persona</button>
  <div id="controls">
    <button id="muteBtn" class="pill-btn">üîä ON</button>
  </div>

  <div id="canvas-container"></div>

  <video id="input_video" playsinline muted></video>
  <canvas id="pose_canvas"></canvas>
  <div class="webcam-label">Permite acceso a la c√°mara para seguir tu guardia</div>

  <div id="camera-error-overlay">
    <div class="camera-error-card">
      <h2 class="text-lg font-black text-rose-200 uppercase tracking-[0.2em] mb-2">Webcam detenida</h2>
      <p id="camera-error-text" class="text-sm text-slate-200 mb-4">No se pudo acceder a la c√°mara. Revisa permisos o conecta un dispositivo.</p>
      <button id="camera-retry-btn" class="pill-btn">‚Üª Reintentar</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    import * as CANNON from 'cannon-es';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { BokehPass } from 'three/addons/postprocessing/BokehPass.js';
    import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

    // DOM refs
    const canvasContainer = document.getElementById('canvas-container');
    const presetBtn = document.getElementById('presetBtn');
    const viewBtn = document.getElementById('viewBtn');
    const muteBtn = document.getElementById('muteBtn');
    const errorOverlay = document.getElementById('camera-error-overlay');
    const errorText = document.getElementById('camera-error-text');
    const retryBtn = document.getElementById('camera-retry-btn');
    const videoEl = document.getElementById('input_video');
    const poseCanvas = document.getElementById('pose_canvas');
    const poseCtx = poseCanvas.getContext('2d');

    // Scene globals
    let scene, renderer, composer, renderPass, bokehPass;
    let orbitControls;
    let world;
    let ringBody;
    let activeCamera, povCamera, orbitCamera;
    let boxer, boxerMixer;
    const mixers = [];
    const clock = new THREE.Clock();

    const state = {
      preset: 'night',
      view: 'first',
      muted: false,
      posePaused: false,
      cameraReady: false
    };

    const audioBank = {
      ambience: new Audio('sonidos/publico_enojado.wav'),
      bell: new Audio('sonidos/campana.mp3'),
      punch: new Audio('sonidos/golpe_1.mp3')
    };
    audioBank.ambience.loop = true;
    audioBank.ambience.volume = 0.4;
    audioBank.bell.volume = 0.9;

    const lightingPresets = {
      day: {
        ambient: 0.35,
        key: { color: 0xffe7c7, intensity: 1.5, position: [3, 5, 2] },
        fill: { color: 0x8db9ff, intensity: 0.6, position: [-4, 3, -1] },
        rim: { color: 0xffffff, intensity: 0.8, position: [0, 4, -4] },
        fog: { color: 0xd0e4ff, density: 0.02 },
        background: 0x0c111b
      },
      night: {
        ambient: 0.18,
        key: { color: 0xffa45b, intensity: 1.8, position: [2.5, 4, 1.5] },
        fill: { color: 0x7bb2ff, intensity: 0.5, position: [-3, 2, -1] },
        rim: { color: 0x5588ff, intensity: 1.1, position: [0.2, 3.5, -3] },
        fog: { color: 0x05060a, density: 0.045 },
        background: 0x05060a
      }
    };

    const lights = {
      ambient: new THREE.HemisphereLight(0xffffff, 0x0b0d16, 0.25),
      key: new THREE.SpotLight(0xffffff, 1.2, 20, Math.PI / 4, 0.4, 1.2),
      fill: new THREE.DirectionalLight(0xffffff, 0.4),
      rim: new THREE.DirectionalLight(0xffffff, 0.6)
    };

    function initScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(lightingPresets[state.preset].background);
      scene.fog = new THREE.FogExp2(lightingPresets[state.preset].fog.color, lightingPresets[state.preset].fog.density);

      const aspect = window.innerWidth / window.innerHeight;
      povCamera = new THREE.PerspectiveCamera(60, aspect, 0.1, 120);
      orbitCamera = new THREE.PerspectiveCamera(60, aspect, 0.1, 120);
      povCamera.position.set(0, 1.65, 0.5);
      orbitCamera.position.set(0, 2.2, 3.4);
      activeCamera = povCamera;

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      canvasContainer.appendChild(renderer.domElement);

      renderPass = new RenderPass(scene, activeCamera);
      bokehPass = new BokehPass(scene, activeCamera, {
        focus: 1.0,
        aperture: 0.00035,
        maxblur: 0.008,
        width: window.innerWidth,
        height: window.innerHeight
      });
      const outputPass = new OutputPass();
      composer = new EffectComposer(renderer);
      composer.addPass(renderPass);
      composer.addPass(bokehPass);
      composer.addPass(outputPass);

      orbitControls = new OrbitControls(orbitCamera, renderer.domElement);
      orbitControls.enableDamping = true;
      orbitControls.target.set(0, 1.4, 0);
      orbitControls.minDistance = 1.2;
      orbitControls.maxDistance = 4.0;

      Object.values(lights).forEach(light => scene.add(light));
      lights.key.castShadow = true;
      applyLightingPreset(state.preset);

      setupPhysics();
      buildRing();
      loadRingModel();
      loadBoxer();

      window.addEventListener('resize', onResize);
      canvasContainer.addEventListener('click', () => {
        if (!state.cameraReady) startCamera();
      });
      document.addEventListener('keydown', handleHotkeys);
      animate();
    }

    function applyLightingPreset(preset) {
      const cfg = lightingPresets[preset];
      lights.ambient.intensity = cfg.ambient;
      lights.key.color.setHex(cfg.key.color);
      lights.key.intensity = cfg.key.intensity;
      lights.key.position.set(...cfg.key.position);
      lights.fill.color.setHex(cfg.fill.color);
      lights.fill.intensity = cfg.fill.intensity;
      lights.fill.position.set(...cfg.fill.position);
      lights.rim.color.setHex(cfg.rim.color);
      lights.rim.intensity = cfg.rim.intensity;
      lights.rim.position.set(...cfg.rim.position);
      scene.background.set(cfg.background);
      scene.fog.color.set(cfg.fog.color);
      scene.fog.density = cfg.fog.density;
      presetBtn.textContent = preset === 'day' ? '‚òÄÔ∏è D√≠a' : 'üåô Noche';
    }

    function setupPhysics() {
      world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82, 0) });
      world.broadphase = new CANNON.SAPBroadphase(world);
      world.defaultContactMaterial.friction = 0.4;

      const floorBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
      floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
      world.addBody(floorBody);
    }

    function buildRing() {
      const ringGeo = new THREE.CylinderGeometry(4.2, 4.2, 0.3, 48);
      const ringMat = new THREE.MeshStandardMaterial({ color: 0x1c2433, roughness: 0.8, metalness: 0.05 });
      const ringMesh = new THREE.Mesh(ringGeo, ringMat);
      ringMesh.receiveShadow = true;
      ringMesh.position.y = -0.15;
      scene.add(ringMesh);

      ringBody = new CANNON.Body({ mass: 0 });
      ringBody.addShape(new CANNON.Box(new CANNON.Vec3(4.2, 0.15, 4.2)));
      ringBody.position.set(0, -0.15, 0);
      world.addBody(ringBody);
    }

    function loadRingModel() {
      const loader = new GLTFLoader();
      loader.load(
        'modelos/Ring 3.glb',
        (gltf) => {
          gltf.scene.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          gltf.scene.position.set(0, 0, 0);
          scene.add(gltf.scene);
        },
        undefined,
        () => console.warn('Ring 3.glb no encontrado, usando plataforma simple')
      );
    }

    function loadBoxer() {
      const gltfLoader = new GLTFLoader();
      gltfLoader.load(
        'modelos/Tyson.glb',
        (gltf) => {
          boxer = gltf.scene;
          boxer.position.set(0, 0, 0.5);
          boxer.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          scene.add(boxer);
          boxerMixer = new THREE.AnimationMixer(boxer);
          mixers.push(boxerMixer);
          loadAnimations();
        },
        undefined,
        (err) => {
          console.warn('No se pudo cargar Tyson.glb, usando marcador b√°sico', err);
          const fallback = new THREE.Mesh(
            new THREE.CapsuleGeometry(0.35, 1.4, 8, 16),
            new THREE.MeshStandardMaterial({ color: 0xffb37a, roughness: 0.5 })
          );
          fallback.castShadow = true;
          fallback.position.set(0, 1.0, 0.5);
          boxer = fallback;
          scene.add(boxer);
        }
      );
    }

    function loadAnimations() {
      const fbxLoader = new FBXLoader();
      const clips = [
        'animaciones/descanso/Action Idle To Fight Idle.fbx',
        'animaciones/ataque/Jab Cross.fbx'
      ];
      clips.forEach((path, idx) => {
        fbxLoader.load(path, (anim) => {
          if (!boxerMixer) return;
          const action = boxerMixer.clipAction(anim.animations[0]);
          action.loop = THREE.LoopRepeat;
          if (idx === 0) action.play();
        });
      });
    }

    function onResize() {
      const aspect = window.innerWidth / window.innerHeight;
      [povCamera, orbitCamera].forEach((cam) => {
        cam.aspect = aspect;
        cam.updateProjectionMatrix();
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
      bokehPass.setSize(window.innerWidth, window.innerHeight);
    }

    function switchView() {
      state.view = state.view === 'first' ? 'third' : 'first';
      activeCamera = state.view === 'first' ? povCamera : orbitCamera;
      renderPass.camera = activeCamera;
      bokehPass.camera = activeCamera;
      viewBtn.textContent = state.view === 'first' ? 'üëÅÔ∏è 1¬™ persona' : 'üì∑ 3¬™ persona';
    }

    function togglePreset() {
      state.preset = state.preset === 'day' ? 'night' : 'day';
      applyLightingPreset(state.preset);
    }

    function toggleMute() {
      state.muted = !state.muted;
      Object.values(audioBank).forEach((audio) => {
        audio.muted = state.muted;
      });
      muteBtn.textContent = state.muted ? 'üîá OFF' : 'üîä ON';
      if (!state.muted && audioBank.ambience.paused) audioBank.ambience.play().catch(() => {});
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      world.step(1 / 60, delta, 3);
      mixers.forEach((m) => m.update(delta));

      orbitControls.enabled = state.view === 'third';
      orbitControls.update();

      if (boxer) {
        if (state.view === 'first') {
          activeCamera.position.lerp(new THREE.Vector3(0, 1.65, 0.5), 0.05);
          activeCamera.lookAt(new THREE.Vector3(0, 1.5, 0));
        } else {
          orbitControls.target.lerp(new THREE.Vector3(0, 1.2, 0.5), 0.08);
        }
      }

      composer.render();
    }

    // Pose pipeline
    let cameraStream;
    const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });
    pose.onResults(onPoseResults);

    function startCamera() {
      try {
        cameraStream = new Camera(videoEl, {
          onFrame: async () => {
            if (!state.posePaused) await pose.send({ image: videoEl });
          },
          width: 640,
          height: 480
        });
        cameraStream.start();
        state.cameraReady = true;
        errorOverlay.classList.remove('visible');
        audioBank.ambience.play().catch(() => {});
      } catch (err) {
        showCameraError('No se pudo iniciar la c√°mara. Revisa permisos.');
        console.error(err);
      }
    }

    function showCameraError(message) {
      errorText.textContent = message;
      errorOverlay.classList.add('visible');
      state.cameraReady = false;
    }

    function onPoseResults(results) {
      if (!poseCtx) return;
      poseCanvas.width = videoEl.videoWidth;
      poseCanvas.height = videoEl.videoHeight;
      poseCtx.clearRect(0, 0, poseCanvas.width, poseCanvas.height);
      if (!results.poseLandmarks) return;
      drawConnectors(poseCtx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#5eead4', lineWidth: 3 });
      drawLandmarks(poseCtx, results.poseLandmarks, { color: '#fbbf24', lineWidth: 2, radius: 2 });

      // Simple arm mapping to boxer rotation
      if (boxer) {
        const rightWrist = results.poseLandmarks[16];
        const leftWrist = results.poseLandmarks[15];
        const chest = results.poseLandmarks[12];
        if (rightWrist && leftWrist && chest) {
          const raise = ((rightWrist.y + leftWrist.y) * 0.5 - chest.y) * -1.2;
          boxer.rotation.y = THREE.MathUtils.lerp(boxer.rotation.y, (rightWrist.x - 0.5) * 1.2, 0.08);
          boxer.rotation.x = THREE.MathUtils.clamp(raise, -0.4, 0.6);
        }
      }
    }

    function handleHotkeys(e) {
      if (e.code === 'KeyV') switchView();
      if (e.code === 'KeyL') togglePreset();
      if (e.code === 'KeyM') toggleMute();
      if (e.code === 'Space') state.posePaused = !state.posePaused;
    }

    // UI bindings
    presetBtn.addEventListener('click', togglePreset);
    viewBtn.addEventListener('click', switchView);
    muteBtn.addEventListener('click', toggleMute);
    retryBtn.addEventListener('click', startCamera);

    initScene();
  </script>
</body>
</html>
